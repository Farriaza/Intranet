{% extends "base.html" %}
{% load static %}

{% block title %}Mi Perfil{% endblock %}

{% block content %}
<style>
  /* ===== OVERRIDE FONDO AZUL ===== */
.perfil-card {
  background: #ffffff !important;
}

.perfil-card .card-body {
  background: #ffffff !important;
}

.perfil-card .card-footer {
  background: #f8f9fc !important;
}

/* ===== PERFIL LAYOUT ===== */
.perfil-wrapper {
  max-width: 1200px;
  margin: auto;
}

.perfil-card {
  border-radius: 14px;
  border: 1px solid #e3e7f5;
}

/* ===== FOTO ===== */
.perfil-foto img {
  border: 3px solid #1f3c88;
}

/* ===== FORM ===== */
.form-label {
  font-size: .85rem;
  font-weight: 600;
  color: #1f3c88;
  margin-bottom: 2px;
}

.form-control,
.form-select {
  font-size: .85rem;
  border-radius: 8px;
}

.form-control:focus,
.form-select:focus {
  border-color: #1f3c88;
  box-shadow: 0 0 0 .1rem rgba(31,60,136,.15);
}

/* ===== SECCIONES ===== */
.section-title {
  font-size: .9rem;
  font-weight: 700;
  color: #1f3c88;
  margin-bottom: .5rem;
}

/* ===== CONTACTOS ===== */
.contact-card {
  border: 1px solid #e3e7f5;
  border-left: 4px solid #1f3c88;
  border-radius: 10px;
  padding: 14px;
  background: #fafbff;
  box-sizing: border-box;
  width: 100%;
}

.contact-card.opcional {
  border-style: dashed;
  background: #fcfcfc;
  
}

/* ===== FOOTER ===== */
.card-footer {
  background: #f8f9fc;
}
</style>

<div class="container my-4 perfil-wrapper">


  <div class="d-flex align-items-center mb-3">
    <i class="bi bi-person-circle fs-4 text-primary me-2"></i>
    <h5 class="fw-bold text-primary mb-0">Mi Perfil</h5>
  </div>

  <div class="card shadow-sm perfil-card">
    <form method="post" action="{% url 'actualizar_perfil' %}" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="card-body">

        <div class="row g-3">

          <!-- FOTO -->
          <div class="col-lg-3 text-center perfil-foto">
            <img id="preview-imagen"
                 src="{% if user.perfil.imagen %}{{ user.perfil.imagen.url }}{% else %}/media/perfiles/perfil.png{% endif %}"
                 class="rounded-circle mb-2"
                 width="120" height="120"
                 style="object-fit: cover;">

            <label for="id_imagen" class="btn btn-outline-primary btn-sm w-100">
              <i class="bi bi-camera me-1"></i> Cambiar foto
            </label>
            <input type="file" name="imagen" id="id_imagen" class="d-none" accept="image/*">
          </div>

          <!-- DATOS -->
          <div class="col-lg-9">
            <div class="row g-2">

              <div class="col-md-6">
                <label class="form-label">Nombres *</label>
                <input type="text" name="first_name" class="form-control" required value="{{ user.first_name }}">
              </div>

              <div class="col-md-6">
                <label class="form-label">Apellidos *</label>
                <input type="text" name="last_name" class="form-control" required value="{{ user.last_name }}">
              </div>

              <div class="col-md-6">
                <label class="form-label">Correo institucional *</label>
                <input type="email" name="email" class="form-control" required value="{{ user.email }}">
              </div>

              <div class="col-md-3">
                <label class="form-label">Anexo *</label>
                <input type="text" name="telefono" class="form-control" required value="{{ user.perfil.telefono }}">
              </div>

              <div class="col-md-3">
                <label class="form-label">RUN *</label>
                <input type="text" name="run" class="form-control" required value="{{ user.perfil.run }}">
              </div>

              <div class="col-md-4">
                <label class="form-label">Fecha nacimiento *</label>
                <input type="date" name="fecha_nacimiento" class="form-control" required
                       value="{{ user.perfil.fecha_nacimiento|date:'Y-m-d' }}">
              </div>

              <div class="col-md-4">
                <label class="form-label">Contrato *</label>
                <select name="estamento" class="form-select" required>
                  {% for est in ESTAMENTOS %}
                    <option value="{{ est.id }}" {% if user.perfil.estamento.id == est.id %}selected{% endif %}>
                      {{ est.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Area *</label>
                <select name="cargo" class="form-select" required>
                  {% for cargo in CARGOS %}
                    <option value="{{ cargo.id }}" {% if user.perfil.cargo.id == cargo.id %}selected{% endif %}>
                      {{ cargo.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-12">
                <label class="form-label">Cargo *</label>
                <select name="unidad_fiscalia" class="form-select" required>
                  {% for uni in UNIDADES %}
                    <option value="{{ uni.id }}" {% if user.perfil.unidad_fiscalia.id == uni.id %}selected{% endif %}>
                      {{ uni.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>

            </div>
          </div>

          <!-- CONTACTOS -->
          <div class="col-12 mt-3">
            <div class="section-title">
              <i class="bi bi-exclamation-circle me-1"></i> Contactos de emergencia
            </div>
          </div>

          <!-- CONTACTO 1 -->
          <div class="col-md-6">
            <div class="contact-card">
              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label">Nombre *</label>
                  <input type="text" name="contacto_nombre" class="form-control" required
                         value="{{ user.perfil.contacto_nombre }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Relación *</label>
                  <input type="text" name="contacto_relacion" class="form-control" required
                         value="{{ user.perfil.contacto_relacion }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Teléfono *</label>
                  <input type="text" name="contacto_telefono" class="form-control" required
                         value="{{ user.perfil.contacto_telefono }}">
                </div>
              </div>
            </div>
          </div>

          <!-- CONTACTO 2 -->
          <div class="col-md-6">
            <div class="contact-card opcional">
              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label">Nombre (opcional)</label>
                  <input type="text" name="contacto2_nombre" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Relación (opcional)</label>
                  <input type="text" name="contacto2_relacion" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Teléfono (opcional)</label>
                  <input type="text" name="contacto2_telefono" class="form-control">
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
      <div class="card-footer text-end">
        <button type="submit" class="btn btn-primary px-4">
          <i class="bi bi-save me-1"></i> Guardar cambios
        </button>
      </div>

    </form>

</div>
<!-- ================= CAPACITACIONES ================= -->
<hr class="my-4">

<div class="section-title mb-2">
  <i class="bi bi-mortarboard me-1"></i> Capacitaciones
</div>

<!-- ===== LISTADO DE CAPACITACIONES ===== -->
{% if capacitaciones %}
  {% for cap in capacitaciones %}
    <div class="contact-card mb-2">
      <div class="row g-2">

        <div class="col-md-4">
          <label class="form-label">Nombre</label>
          <input type="text"
                 class="form-control"
                 value="{{ cap.nombre }}"
                 readonly>
        </div>

        <div class="col-md-3">
          <label class="form-label">Institución</label>
          <input type="text"
                 class="form-control"
                 value="{{ cap.institucion }}"
                 readonly>
        </div>

        <div class="col-md-3">
          <label class="form-label">Fecha</label>
          <input type="date"
                 class="form-control"
                 value="{{ cap.fecha|date:'Y-m-d' }}"
                 readonly>
        </div>

        <div class="col-md-2">
          <label class="form-label">Documento</label>
          {% if cap.documento %}
            <a href="{{ cap.documento.url }}"
               target="_blank"
               class="btn btn-outline-primary btn-sm w-100">
              <i class="bi bi-file-earmark"></i> Ver
            </a>
          {% else %}
            <span class="text-muted small">Sin archivo</span>
          {% endif %}
        </div>

      </div>
    </div>
  {% endfor %}
{% else %}
  <p class="text-muted">No hay capacitaciones registradas.</p>
{% endif %}

<!-- ===== FORMULARIO NUEVA CAPACITACIÓN ===== -->
<form method="post"
      action="{% url 'guardar_capacitacion' %}"
      enctype="multipart/form-data"
      class="mt-3">

  {% csrf_token %}

  <div class="contact-card">
    <div class="row g-2">

      <div class="col-md-4">
        <label class="form-label">Nombre</label>
        <input type="text"
               name="nombre"
               class="form-control"
               required>
      </div>

      <div class="col-md-3">
        <label class="form-label">Institución</label>
        <input type="text"
               name="institucion"
               class="form-control"
               required>
      </div>

      <div class="col-md-3">
        <label class="form-label">Fecha</label>
        <input type="date"
               name="fecha"
               class="form-control"
               required>
      </div>

      <div class="col-md-2">
        <label class="form-label">Documento</label>
        <input type="file"
               name="documento"
               class="form-control">
      </div>

      <div class="col-12 text-end mt-2">
        <button type="submit"
                class="btn btn-success btn-sm">
          <i class="bi bi-upload"></i> Subir capacitación
        </button>
      </div>

    </div>
  </div>
</form>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".auto-dismiss").forEach(alert => {
      setTimeout(() => {
        alert.classList.remove("show");
        alert.classList.add("fade");
        setTimeout(() => alert.remove(), 500);
      }, 4000);
    });
  });
</script>

{% endblock %}
